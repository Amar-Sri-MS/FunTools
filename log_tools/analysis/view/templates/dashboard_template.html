<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" type="text/css" href="/static/css/index.css">
    <link rel="stylesheet" type="text/css" href="/static/css/dashboard.css">
    <title>Log Analyzer Dashboard: {{log_id}}</title>
</head>
<body>
    {% include 'nav_bar.html' ignore missing %}
    <!-- Macro for calculating percentage and rounding it off to a given precision -->
    {% macro calculatePercentage(count, total, precision=2) -%}
        {{((count/total)*100)|round(precision)}}%
    {%- endmacro %}
    <div class="content">
        <h2 class="center-align">Dashboard for <b>{{log_id}}</b></h2>
        <div class="container">
            <h3>Explore logs by source</h3>
            {% set total_entries = sources.values()|sum() %}
            <div>Total log entries: <b>{{total_entries}}</b></div>
            <div class="filters_container">
                <div class="filter_box_container">
                    {% for system_type in unique_entries %}
                        {% set total_entries = system_type['doc_count'] %}
                        {% set system_type_index = loop.index0 %}
                        <div class="filter_box">
                            <div class="filter_box_header">
                                <div>
                                    <input type="checkbox" id="{{system_type['key']}}" name="system_type" data-system_type_index="{{system_type_index}}"
                                    value="{{system_type['key']}}" onclick="toggleSystemTypeSelection(this)" checked />
                                    <label for="{{system_type['key']}}">
                                        System Type: {{system_type['key']}} ({{total_entries}})
                                    </label>
                                </div>
                                <div style="padding: 0px 5px; cursor: pointer;" onclick="toggleShowFilterBox(this, `filter-box-content-{{system_type['key']}}`)">
                                    <span class="arrow down"></span>
                                </div>
                            </div>
                            <div class="filter_box_content" id="filter-box-content-{{system_type['key']}}">
                                <ul>
                                {% for system_id in system_type['system_id']['buckets'] %}
                                    {% set system_id_distribution = calculatePercentage(system_id['doc_count'], total_entries) %}
                                    <!-- Unique system id using system type and system id to handle same systemID names -->
                                    {% set unique_system_id = system_type_index ~ system_type['key'] ~ system_id['key'] %}
                                    <li>
                                        <div class="filter_header">
                                            <input type="checkbox" id="{{unique_system_id}}" name="system_id" value="{{system_id['key']}}"
                                                data-system_type="{{system_type['key']}}" onclick="toggleSystemIDSelection(this)" checked
                                            />
                                            <label for="{{unique_system_id}}">System ID: {{system_id['key']}} ({{system_id_distribution}})</label>
                                        </div>
                                        <ul>
                                        {% for source in system_id['src']['buckets'] %}
                                            {% set source_distribution = calculatePercentage(source['doc_count'], total_entries) %}
                                            <li class="filter_box_item">
                                                <input type="checkbox" id="{{unique_system_id}}_{{source['key']}}" name="source" value="{{source['key']}}"
                                                    data-system_id="{{system_id['key']}}" data-system_type="{{system_type['key']}}" onclick="toggleSourceSelection(this)" checked
                                                />
                                                <label for="{{unique_system_id}}_{{source['key']}}">{{source['key']}} ({{source_distribution}})</label>
                                            </li>
                                        {% endfor %}
                                        </ul>
                                    </li>
                                {% endfor %}
                                </ul>
                            </div>
                        </div>
                    {% endfor %}
                </div>
                <div id="explore_button">
                    <button class="btn" onclick="onClickExploreLogs()">Explore Logs <span class="arrow right"></span></button>
                </div>
            </div>
        </div>
        <div class="container row">
            <div class="distribution_stats">
                <h3>Log Distribution</h3>
                <div>
                    Sources:
                    <select name="sources" id="sources" onchange="onSelectSourceForLogLevelStats(this)">
                        <option value="all" selected>All</option>
                        {% for source in sources %}
                            <option value="{{source}}">{{source}}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="content">
                    <div id="log_level_stats">
                        <div class="level_stat">Total: {{total_entries}}(100%)</div>
                        <!-- Displaying log entries for a source and each log levels in % with rounded off to 2 decimals -->
                        {% for level, stat in log_level_stats.items() %}
                            {% set log_distribution = calculatePercentage(stat.count, total_entries) %}
                            <div class="level_stat" title="{{stat.keywords}}">
                                <a href="{{stat.kibana_url}}" target="_blank">{{level}}</a>: {{stat.count}}({{log_distribution}})
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            <div class="separator"></div>
            <div>
                <h3>Interesting events from FunOS logs</h3>
                <div>
                    <input type="checkbox" id="failedAnchors" value="showFailedAnchors" onchange="toggleShowOnlyFailedAnchors(this)" checked>
                    <label for="failedAnchors">Show only failed events?</label><br>
                </div>
                <div class="log_entries scrollable">
                    <table>
                        <thead>
                            <tr>
                                <th style="text-align: left">Source</th>
                                <th style="text-align: left">System ID</th>
                                <th style="text-align: left">Timestamp</th>
                                <th style="text-align: left">Description</th>
                            </tr>
                        </thead>
                        <tbody id="anchors">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="container">
            <h3>Recent
                <select name="level" id="level" onchange="onSelectLevelForRecentLogs(this)">
                    {% for level, stat in log_level_stats.items() %}
                        <option value="{{level}}">{{level}}</option>
                    {% endfor %}
                </select>
                logs for
                <select name="sources" id="recent_source" onchange="onSelectSourceForRecentLogs(this)">
                    <option value="all" selected>All</option>
                    {% for source in sources %}
                        <option value="{{source}}">{{source}}</option>
                    {% endfor %}
                </select> source(s)</h3>
            <div class="content">
                <div class="log_entries" id="recent_logs">
                    {{recent_logs}}
                </div>
            </div>
        </div>
        <div class="container">
            <h3>Top 10 duplicated logs (all sources)</h3>
            <div class="log_entries">
                <!-- {% include 'analytics/'+log_id+'/duplicates.html' ignore missing %} -->
                <table>
                    <thead>
                        <tr>
                            <th style="text-align: left">Duplicates</th>
                            <th style="text-align: left">Source</th>
                            <th style="text-align: left">System ID</th>
                            <th style="text-align: left">Timestamp</th>
                            <th style="text-align: left">Description</th>
                        </tr>
                    </thead>
                    <tbody id="duplicates">
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</body>
<script type="text/javascript">
    // Kibana URL for redirecting to Kibana with given query.
    // URL String contains a term 'KIBANA_QUERY' which should be replaced
    // with a given query
    const KIBANA_BASE_URL = "{{kibana_base_url}}";
    const systemTypeInputElements = Array.from(document.getElementsByName('system_type'));
    const logLevelStatsElement = document.getElementById('log_level_stats');
    const recentLogsElement = document.getElementById('recent_logs');

    const logId = "{{log_id}}";
    const sources = {{sources}};
    const uniqueEntries = {{unique_entries}};
    let selectedFilters = {};

    const filterComponents = uniqueEntries.reduce((filterComponents, entries, systemTypeIndex) => {
        const systemType = entries['key'];
        selectedFilters[systemType] = {};
        const systemTypeElements = Array.from(document.querySelectorAll(`input[name="system_id"][data-system_type="${systemType}"]`));

        entries['system_id']['buckets'].forEach(systemIDEntry => {
            const systemID = systemIDEntry["key"];
            const uniqueKeyForSystemID = `${systemTypeIndex}_${systemType}_${systemID}`;
            const systemIDElements = Array.from(document.querySelectorAll(`[data-system_type="${systemType}"][data-system_id="${systemID}"]`));
            filterComponents["system_id"][uniqueKeyForSystemID] = systemIDElements;
            selectedFilters[systemType][systemID] = systemIDElements.map(element => element.value);
        });

        filterComponents["system_type"][systemType] = systemTypeElements;
        return filterComponents;
    }, {"system_type": {}, "system_id": {}});

    // Total log entries indexed in ES
    const totalEntries = Object.keys(sources).reduce((total, source) => (total + sources[source]), 0);
    let logLevelStats = {{log_level_stats}};
    const sortedLogLevel = Object.keys(logLevelStats).sort((level1, level2) => logLevelStats[level1]['order'] - logLevelStats[level2]['order']);
    let selectedSourceForLogLevelStats = "all";
    let selectedSourceForRecentLogs = "all", selectedLevelForRecentLogs = sortedLogLevel[0];

    const analyticsData = {{analytics_data}};
    let selectedSourceForAnchors = "all", showOnlyFailedAnchors = true;
    const anchorTableBodyElement = document.getElementById('anchors');
    const duplicateTableBodyElement = document.getElementById('duplicates');

    // Self invocation function
    (function () {
        // Update anchors when the DOM is available
        updateAnchors();
        updateDuplicates();
    })();


    function toggleSystemTypeSelection(systemTypeElement) {
        // Toggle the state of input checkbox of system_type
        // States: checked, indeterminate and unchecked
        const systemType = systemTypeElement.value;
        const isChecked = systemTypeElement.checked;
        filterComponents["system_type"][systemType].forEach(systemIDElement => {
            // Toggles the system_id elements within the system_type
            systemIDElement.checked = isChecked;
            toggleSystemIDSelection(systemIDElement);
        });
        if (!isChecked) {
            selectedFilters[systemType] = {};
        }
    }


    function toggleSystemIDSelection(systemIDElement) {
        // Toggle the state of input checkbox of system_type, system_id
        // States: checked, indeterminate and unchecked
        const systemID = systemIDElement.value;
        const isChecked = systemIDElement.checked;

        const dataset = systemIDElement.dataset;
        const systemType = dataset.system_type;

        const systemTypeElement = systemTypeInputElements.find(type => type.value === systemType);
        const systemTypeIndex = systemTypeElement.dataset.system_type_index;
        const uniqueKeyForSystemID = `${systemTypeIndex}_${systemType}_${systemID}`;
        const systemIDElements = filterComponents["system_id"][uniqueKeyForSystemID];

        systemIDElements.forEach(component => {
            // Selects all the sources within the system_id
            component.checked = isChecked;
        });
        if (isChecked) {
            selectedFilters[systemType][systemID] = systemIDElements.map(component => component.value);
        }
        else {
            delete selectedFilters[systemType][systemID];
        }

        const selectedSystemIDs = Object.keys(selectedFilters[systemType]);
        if (selectedSystemIDs.length === 0) {
            // All the system ids under a system_type are not selected
            systemTypeElement.checked = false;
            systemTypeElement.indeterminate = false;
        }
        else if(filterComponents["system_type"][systemType].every(component => component.checked)) {
            // All the system ids under a system_type are selected
            systemTypeElement.checked = true;
            systemTypeElement.indeterminate = false;
        }
        else {
            systemTypeElement.indeterminate = true;
        }
    }


    function toggleSourceSelection(sourceElement) {
        // Toggle the state of input checkbox of system_type, system_id, source
        // States: checked, indeterminate and unchecked
        const isChecked = sourceElement.checked;
        const dataset = sourceElement.dataset;
        const systemType = dataset.system_type;
        const systemID = dataset.system_id;

        const systemTypeElement = systemTypeInputElements.find(type => type.value === systemType);
        const systemTypeIndex = systemTypeElement.dataset.system_type_index;
        const uniqueKeyForSystemID = `${systemTypeIndex}_${systemType}_${systemID}`;

        const systemIDElement = filterComponents["system_type"][systemType].find(ids => ids.value === systemID);
        const totalSystemIDs = filterComponents["system_type"][systemType].length;
        const totalSources = filterComponents["system_id"][uniqueKeyForSystemID].length;

        if (isChecked) {
            // Adding the source to the selected filters
            if (!(systemID in selectedFilters[systemType])) {
                // If the source is the first selected item in the selectedFilters object
                selectedFilters[systemType][systemID] = [];
            }
            selectedFilters[systemType][systemID].push(sourceElement.value);

            // Toggling the state of system_id
            const selectedSources = selectedFilters[systemType][systemID];
            if (selectedSources.length === 1) {
                // First source checked for the system_id
                systemIDElement.indeterminate = true;
            }
            else if (selectedSources.length == totalSources) {
                // All the sources checked within the system_id
                systemIDElement.checked = true;
                systemIDElement.indeterminate = false;
            }

            // Toggling the state of system_type
            const selectedSystemIDs = Object.keys(selectedFilters[systemType]);
            if (selectedSystemIDs.length === 1) {
                // First system_id for the system_type
                systemTypeElement.checked = false;
                systemTypeElement.indeterminate = true;
            }
            if(filterComponents["system_type"][systemType].every(component => component.checked)) {
                // All the system_ids checked within the system_type
                systemTypeElement.checked = true;
                systemTypeElement.indeterminate = false;
            }
        }
        else {
            // Removing source from the selected filters
            selectedFilters[systemType][systemID] = selectedFilters[systemType][systemID].filter(values => values != sourceElement.value);
            if (selectedFilters[systemType][systemID].length === 0) {
                // All the sources unchecked within the system_id
                systemIDElement.checked = false;
                systemIDElement.indeterminate = false;
                delete selectedFilters[systemType][systemID];
            }
            else {
                systemIDElement.indeterminate = true;
            }
            const selectedSystemIDs = Object.keys(selectedFilters[systemType]);
            if (selectedSystemIDs.length === 0) {
                // All the system_ids unchecked within the system_type
                systemTypeElement.indeterminate = false;
                systemTypeElement.checked = false;
            }
            else {
                systemTypeElement.indeterminate = true;
            }
        }
    }


    function onClickExploreLogs() {
        // Builds query based on the selected filters and redirects to Kibana
        let queries = [];
        for (const [systemType, systemIDs] of Object.entries(selectedFilters)) {
            for (const [systemID, sources] of Object.entries(systemIDs)) {
                const systemTypeQuery = `system_type:"${systemType}" and`;
                const systemIDQuery =`system_id:"${systemID}" and`;
                queries.push(`(${systemTypeQuery} ${systemIDQuery} src:(${sources.join(' or ')}))`);
            }
        }
        if (queries.length === 0) {
            // Show error message that no source is being selected
            alert("Select any filter to explore logs");
            return;
        }
        let query = encodeURI(queries.join(' or '));

        const kibana_url = KIBANA_BASE_URL.replace("KIBANA_QUERY", query);
        window.open(kibana_url, "_blank");
    }


    function onSelectSourceForLogLevelStats(sourceElement) {
        // Fetch log level stats for the selected source
        let xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
                let data = JSON.parse(xhttp.responseText);
                if (data) {
                    selectedSourceForLogLevelStats = sourceElement.value;
                    updateLogLevelStats(data);
                }
            }
        }

        let uri = `${window.location.href}/level-stats`;
        if (sourceElement.value !== 'all') {
            source = sourceElement.value;
            uri = `${uri}?source=${source}`;
        }

        xhttp.open('GET', uri);
        xhttp.send();
    }

    function updateLogLevelStats(stats) {
        // Updates the Log Level distribution
        let totalEntriesForSource = selectedSourceForLogLevelStats === "all" ?
                                    totalEntries :
                                    sources[selectedSourceForLogLevelStats];
        const kibanaUrlForSource = getKibanaURLForSources([selectedSourceForLogLevelStats]);

        // Sorting log levels by severity order
        const logLevels = Object.keys(stats).sort((level1, level2) => stats[level1]['order'] - stats[level2]['order']);

        let divs = [`<div class="level_stat"><a href="${kibanaUrlForSource}" target="_blank">Total</a>: ${totalEntriesForSource}(${Math.round((totalEntriesForSource/totalEntries)*100)}%)</div>`];
        for (const level of logLevels) {
            const stat = stats[level];
            // let logDistribution = Math.round((stat.count/totalEntriesForSource)*100);
            let logDistribution = ((stat.count/totalEntriesForSource)*100).toFixed(2);
            divs.push(`<div class="level_stat" title="${stat.keywords}"><a href="${stat.kibana_url}" target="_blank">${level}</a>: ${stat.count}(${logDistribution}%)</div>`);
        }
        logLevelStatsElement.innerHTML = divs.join('\n');
    }

    function onSelectLevelForRecentLogs(levelElement) {
        selectedLevelForRecentLogs = levelElement.value;
        fetchRecentLogs();
    }

    function onSelectSourceForRecentLogs(sourceElement) {
        selectedSourceForRecentLogs = sourceElement.value;
        fetchRecentLogs();
    }

    function fetchRecentLogs() {
        // Fetch recent logs for the selected level source
        let xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
                const data = xhttp.responseText;
                if (data) {
                    updateRecentLogs(data);
                }
            }
        }

        let uri = `${window.location.href}/recent?level=${selectedLevelForRecentLogs}`;
        if (selectedSourceForRecentLogs !== 'all') {
            uri = `${uri}&source=${selectedSourceForRecentLogs}`;
        }

        xhttp.open('GET', uri);
        xhttp.send();
    }

    function updateRecentLogs(logs) {
        recentLogsElement.innerHTML = logs;
    }

    function toggleShowOnlyFailedAnchors(element) {
        showOnlyFailedAnchors = element.checked;
        updateAnchors();
    }

    function updateAnchors() {
        let tableRows = [];
        for (const anchor of analyticsData['anchors']) {
            if ((showOnlyFailedAnchors && !anchor['is_failure'])
                || (selectedSourceForAnchors !== "all" && anchor['source'] !== selectedSourceForAnchors)) {
                continue;
            }

            tableRows.push(
                `<tr>
                    <td>${anchor['source']}</td>
                    <td>${anchor['system_id']}</td>
                    <td>${anchor['datetime']}</td>
                    <td><a href="${anchor['link']}" target="_blank">${anchor['description']}</a></td>
                </tr>`
            );
        }
        if (tableRows.length === 0) {
            anchorTableBodyElement.innerHTML = `<div>No results</div>`;
            return;
        }
        anchorTableBodyElement.innerHTML = tableRows.join('\n');
    }

    function updateDuplicates() {
        let tableRows = [];
        for (const duplicate of analyticsData['duplicates']) {
            tableRows.push(
                `<tr>
                    <td>${duplicate['count']}</td>
                    <td>${duplicate['source']}</td>
                    <td>${duplicate['system_id']}</td>
                    <td>${duplicate['datetime']}</td>
                    <td><a href="${duplicate['link']}" target="_blank">${duplicate['msg']}</a></td>
                </tr>`
            );
        }
        if (tableRows.length === 0) {
            duplicateTableBodyElement.innerHTML = `<div>No results</div>`;
            return;
        }
        duplicateTableBodyElement.innerHTML = tableRows.join('\n');
    }

    function getKibanaURLForSources(sources) {
        // Creates a Kibana URL for the given sources
        let query = "";
        if (!sources.includes("all"))
            query = encodeURI(`src:(${sources.join(" or ")})`);
        const kibana_url = KIBANA_BASE_URL.replace("KIBANA_QUERY", query);
        return kibana_url;
    }

    function appendQueryForFilter(query, filterKey, filters=[], operation="and") {
        // Form a query and append to an existing query

        // If no filters are present
        if (filters.length === 0) {
            return query;
        }

        // If all the filters are included
        if (filters.includes("all")) {
            return query;
        }

        // If it is not the first query then it needs to be
        // appended with an operation either OR or AND.
        if (query !== "") {
            query = `${query} ${operation}`;
        }

        encodedQuery = encodeURI(`${filterKey}:(${filters.join(" or ")})`);
        query = `${query} ${encodedQuery}`;
        return query;
    }

    function toggleShowFilterBox(arrowElement, filterBoxId) {
        // Toggling the display of filter box
        const filterBoxElement = document.getElementById(filterBoxId);
        if (filterBoxElement.style.display === "none" || filterBoxElement.style.display === "") {
            filterBoxElement.style.display = "block";
            arrowElement.firstElementChild.classList.remove('down');
            arrowElement.firstElementChild.classList.add('up');
        }
        else {
            filterBoxElement.style.display = "none";
            arrowElement.firstElementChild.classList.remove('up');
            arrowElement.firstElementChild.classList.add('down');
        }
    }

</script>
</html>