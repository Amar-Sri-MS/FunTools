<html>
    <head>
        <title>Log Analyzer: Ingester</title>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.17.37/css/bootstrap-datetimepicker.min.css">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
        <link rel="stylesheet" type="text/css" href="/static/css/index.css">
    </head>
    <body>
        {% include "nav_bar.html" ignore missing %}
        <div class="center-align">
            <h3>Ingest logs from QA dashboard</h3>
            <div class="container row">
                <div style="width: 100%; min-width: 60%;">
                    <form action="/ingest" onsubmit="return onSubmit(this)" method="POST">
                        <div class="form-group">
                            <label>QA Job ID</label>
                            <input type="text" id="job_id" name="job_id" placeholder="Enter the JOB ID" value="{{feedback.job_id if feedback else null}}">
                        </div>
                        <div class="form-group">
                            <label>QA Test Index (Default is 0)</label>
                            <input type="text" id="test_index" name="test_index" placeholder="Enter the Test Index" value="{{feedback.test_index if feedback else 0}}">
                        </div>
                        <div class="form-group">
                            <label>Enter tags (comma separated)</label>
                            <input type="text" id="tags" name="tags" placeholder="Enter tags" value="{{feedback.tags if feedback else null}}">
                        </div>
                        <div class="form-group" style="flex-direction: column;">
                            <h4 class="form-title">Filter logs by time <span class="info">Ingests all the logs if no timeframe is provided</span></h4>
                            <div class="form-group">
                                <label>Start time</label>
                                <div class="input-group date" id="datetimepicker1">
                                    <input type="text" id="start_time" name="start_time" class="form-control" />
                                    <span class="input-group-addon">
                                        <span class="glyphicon glyphicon-calendar"></span>
                                    </span>
                                </div>
                                <label>End time</label>
                                <div class="input-group date" id="datetimepicker2">
                                    <input type="text" id="end_time" name="end_time" class="form-control" />
                                    <span class="input-group-addon">
                                        <span class="glyphicon glyphicon-calendar"></span>
                                    </span>
                                </div>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">Ingest</button>
                    </form>
                </div>
                <div class="separator"></div>
                <div id="status-container">
                    {% if feedback %}
                        {% if feedback.started %}
                            <button class="btn btn-primary" onclick="checkStatus()">Check Status</button>
                        {% elif not feedback.success %}
                            <p class="text-danger float-right">ERROR: {{ feedback.msg }}</p>
                        {% endif %}
                    {% endif %}
                    <div id="status"></div>
                    <div id="feedback"></div>
                </div>
            </div>
        </div>
    </body>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/momentjs/2.14.1/moment.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.17.37/js/bootstrap-datetimepicker.min.js"></script>
    <script type="text/javascript">

        $(function () {
            $("#datetimepicker1").datetimepicker({
                sideBySide: true
            });
            $("#datetimepicker2").datetimepicker({
                sideBySide: true
            });
        });

        // Avoid resubmitting POST from form on refresh or page navigation
        if (window.history.replaceState) {
            window.history.replaceState(null, null, window.location.href);
        }

        const feedback = {{feedback|tojson}};
        const statusContainer = document.getElementById("status-container");
        const statusElement = document.getElementById("status");
        const feedbackElement = document.getElementById("feedback");

        // Time is in milliseconds
        const WAIT_TIME_TO_CHECK_STATUS = 30 * 1000;

        let logID = '', statusInterval = null;
        if (feedback && Object.keys(feedback).length !== 0 && feedback.constructor === Object) {
            logID = `log_qa-${feedback["job_id"]}-${feedback["test_index"]}`;

            if (feedback.started) {
                statusContainer.style = "width: 40%;";
                if (feedback.success) {
                    handleStatusUpdate(feedback.metadata);
                }
                else {
                    statusElement.innerHTML = "<p>Ingesting.. Please wait.</p>";
                    statusInterval = setInterval(checkStatus, WAIT_TIME_TO_CHECK_STATUS);
                }
            const dateFormatter = new Intl.DateTimeFormat('en-US', {
                'dateStyle': 'short',
                'timeStyle': 'short',
                'timeZone': 'UTC'
            });
            if (feedback.start_time) {
                const date = new Date(0);
                date.setSeconds(parseInt(feedback.start_time));
                document.getElementById("start_time").value = dateFormatter.format(date);
            }
            if (feedback.end_time) {
                const date = new Date(0);
                date.setSeconds(parseInt(feedback.end_time));
                document.getElementById("end_time").value = dateFormatter.format(date);
            }

            }
        }

        function onSubmit(event) {
            const job_id = event.elements["job_id"].value;
            const start_time_str = event.elements["start_time"].value;
            const end_time_str = event.elements["end_time"].value;

            if (job_id == undefined || job_id === "") {
                alert("Job ID is missing");
                return false;
            }

            if (start_time_str) {
                const start_time = new Date(`${start_time_str} UTC`);
                event.elements["start_time"].value = Math.floor(start_time.getTime()/1000);
            }

            if (end_time_str) {
                const end_time = new Date(`${end_time_str} UTC`);
                event.elements["end_time"].value = Math.ceil(end_time.getTime()/1000);
            }

            statusElement.innerHTML = "<p>Ingesting.. Please wait.</p>";
            feedbackElement.innerHTML = "";
            return true;
        }

        function checkStatus() {
            let xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function() {
                if (this.readyState == 4 && this.status == 200) {
                    let data = JSON.parse(xhttp.responseText);
                    if (data && "ingestion_status" in data) {
                        handleStatusUpdate(data);
                    }
                }
            }

            const uri = `${window.location.href}/${logID}/status`;
            xhttp.open('GET', uri);
            xhttp.send();
        }

        function handleStatusUpdate(metadata) {
            const status = "ingestion_status" in metadata ? metadata["ingestion_status"] : "STARTING";
            statusElement.innerHTML = `
                <p>Status: ${status}</p>
                <p>Last checked: ${new Date()}</p>
            `;
            if (status == "COMPLETED") {
                const logID = metadata["logID"];
                const dashboardLink = `${window.location.origin}/log/${logID}/dashboard`;
                const downloadTime = "download_time" in metadata ? +metadata["download_time"].toFixed(2) : "Unknown";
                const ingestionTime = "ingestion_time" in metadata ? +metadata["ingestion_time"].toFixed(2) : "Unknown";
                feedbackElement.innerHTML = `
                    <p>SUCCESS! <a href="${dashboardLink}">Click to explore the logs</a></p>
                    <p>Time taken to download log archive: ${downloadTime}s</p>
                    <p>Time taken to ingest: ${ingestionTime}s</p>
                `;
                clearInterval(statusInterval);
            }
            else if ("download_time" in metadata &&
                (status == "DOWNLOAD_COMPLETED" || status == "INGESTION_IN_PROGRESS")
            ) {
                const downloadTime = +metadata["download_time"].toFixed(2);
                feedbackElement.innerHTML = `
                    <p>Time taken to download log archive: ${downloadTime}s</p>
                `;
            }
            else if (status == "FAILED") {
                feedbackElement.innerHTML = `
                    <p class="text-danger float-right">ERROR: ${metadata["ingestion_error"]}</p>
                `;
                clearInterval(statusInterval);
            }
        }

    </script>
</html>