#!/bin/sh -e

PATH="/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin"

CONFIG_DIR=/persist/config
INTERFACES_DIR=$CONFIG_DIR/interfaces

case "$1" in
    start)
        mkdir -p /tmp/interfaces.d
        ln -s /etc/network/eth0_0-dhcp.iface /tmp/interfaces.d/eth0_0

        fsck_code=0
        e2fsck -y /dev/vda3 || fsck_code=$?
        if [ $fsck_code -ge 4 ] ; then
            echo 'Filesystem on /dev/vda3 unusable, reformatting...'
            mkfs.ext4 -q -F /dev/vda3
        fi
        mount /persist
        mkdir -p $INTERFACES_DIR
        (  cd $INTERFACES_DIR
           for file in *.iface ; do
               if [ -e $file ] ; then
		   link_name=$(echo $file | sed -e 's/\.iface$//')
                   ln -f -s $INTERFACES_DIR/$file /tmp/interfaces.d/$link_name
               fi
           done
        )
        if [ -e $INTERFACES_DIR/resolv.conf ] ; then
            ln -f -s $INTERFACES_DIR/resolv.conf /tmp/resolv.conf
        fi
	if [ -e $CONFIG_DIR/timezone ] ; then
	    ln -f -s $CONFIG_DIR/timezone /tmp/timezone
	else
	    echo 'Universal' > /tmp/timezone
	fi
	if [ -e $CONFIG_DIR/localtime ] ; then
	    ln -f -s $CONFIG_DIR/localtime /tmp/localtime
	else
	    ln -f -s /usr/share/zoneinfo/Universal /tmp/localtime
	fi
        ;;
    *)
        :
        ;;
esac

exit 0
